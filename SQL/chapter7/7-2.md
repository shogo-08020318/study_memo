# 結合（テーブルを列方向に連結する）
### 結合とは
7-1でやった、**UNION**や**INTERSECT**のような集合演算は、**行方向**に作用する。
これらを使うと行数が増えたり、減ったりする。
集合演算の場合は列数が一致していたので、列数が増減することはない。

「**結合（JOIN）**」は、別のテーブルから列を以ってきて「列を増やす」操作。
これが役に立つのは、欲しいデータ（列）が1つのテーブルからだけでは選択できない場合。
結合すると複数のテーブルからデータを選択することが可能

### 内部結合---INNER JOIN
テーブルの再掲
`Shohin`テーブル
```sql
 shohin_id |   shohin_mei   | shohin_bunrui | hanbai_tanka | shiire_tanka |  torokubi  
-----------+----------------+---------------+--------------+--------------+------------
 0001      | Tシャツ        | 衣服          |         1000 |          500 | 2009-09-20
 0002      | 穴あけパンチ   | 事務用品      |          500 |          320 | 2009-09-11
 0003      | カッターシャツ | 衣服          |         4000 |         2800 | 
 0004      | 包丁           | キッチン用品  |         3000 |         2800 | 2009-09-20
 0005      | 圧力鍋         | キッチン用品  |         6800 |         5000 | 2009-01-15
 0006      | フォーク       | キッチン用品  |          500 |              | 2009-09-20
 0007      | おろしがね     | キッチン用品  |          880 |          790 | 2008-04-28
 0008      | ボールペン     | 事務用品      |          100 |              | 2009-11-11
```
`TenpoShohin`テーブル
```sql
 tenpo_id | tenpo_mei | shohin_id | suryo 
----------+-----------+-----------+-------
 000A     | 東京      | 0001      |    30
 000A     | 東京      | 0002      |    50
 000A     | 東京      | 0003      |    15
 000B     | 名古屋    | 0002      |    30
 000B     | 名古屋    | 0003      |   120
 000B     | 名古屋    | 0004      |    20
 000B     | 名古屋    | 0006      |    10
 000B     | 名古屋    | 0007      |    40
 000C     | 大阪      | 0003      |    20
 000C     | 大阪      | 0004      |    50
 000C     | 大阪      | 0006      |    90
 000C     | 大阪      | 0007      |    70
 000D     | 福岡      | 0001      |   100
```
#
2つのテーブルの列に注目する。
**A：共通で存在する列**
→商品ID（shohin_id）

**B：片方にしか存在しない列**
→商品ID以外の列

結合とは、「Aに属する列を橋渡しの'橋'に使って、Bに属する列同士を一緒の結果に含めてしまうこと」。

そこで、`Shohin`テーブルから、商品名と販売単価の列を持ってきて、`TenpoShohin`テーブルに「くっつけて」見る。
```sql
 tenpo_id | tenpo_mei | shohin_id |   shohin_mei   | hanbai_tanka 
----------+-----------+-----------+----------------+--------------
 000A     | 東京      | 0002      | 穴あけパンチ   |          500
 000A     | 東京      | 0003      | カッターシャツ |         4000
 000A     | 東京      | 0001      | Tシャツ        |         1000
 000B     | 名古屋    | 0007      | おろしがね     |          880
 000B     | 名古屋    | 0002      | 穴あけパンチ   |          500
 000B     | 名古屋    | 0003      | カッターシャツ |         4000
 000B     | 名古屋    | 0004      | 包丁           |         3000
 000B     | 名古屋    | 0006      | フォーク       |          500
 000C     | 大阪      | 0007      | おろしがね     |          880
 000C     | 大阪      | 0006      | フォーク       |          500
 000C     | 大阪      | 0003      | カッターシャツ |         4000
 000C     | 大阪      | 0004      | 包丁           |         3000
 000D     | 福岡      | 0001      | Tシャツ        |         1000
```

SQLは以下のようになる。
```sql
SELECT TS.tenpo_id, TS.tenpo_mei, TS.shohin_id, S.shohin_mei, S.hanbai_tanka
  FROM TenpoShohin AS TS INNER JOIN Shohin AS S
    ON TS.shohin_id = S.shohin_id
ORDER BY tenpo_id;
```

ポイントは3つ
**①FROM句**
FROM句に、`TenpoShohin`と`Shohin`の2つのテーブルを書いていること。
これを可能にするのが、「**INNER JOIN**」。

**②ON句**
**ON**句を使って、2つのテーブルを結びつける列（**結合キー**）を指定する。
今回だと、`shohin_id`がそれになる。

複数の結合キーを指定するために、**AND**や**OR**を使うこともできる。
ON句は必須で、FROM句とWHERE句の間。

結合条件は基本的に「=」で記述する。
「<=」やBETWEENも使えるが、ほぼ「=」で足りる。

**③SELECT句**
SELECT句では、**TS.tenpo_id**や**S.habani_tanka**のように、**<テーブルの別名>.<列名>**という記述になっている。
テーブルを結合した場合、どの列をどのテーブルから持ってきているか混乱するのを防ぐため。
構文的にこのような書き方をしないといけないのは、2つのテーブルに存在している列（今回の場合、shohin_id）のみで、ほかの列は「tenpo_id」のように列名だけを書いてもエラーならない。
混乱を避けるために全ての列を<テーブルの別名>.<列名>の形式で書いた方が良い。

**内部結合とWHERE句を組み合わせる**
全店舗ではなく、東京店だけを結果に得たいなら、以下のようにWHERE句の条件を追加する。
```sql
SELECT TS.tenpo_id, TS.tenpo_mei, TS.shohin_id, S.shohin_mei, S.hanbai_tanka
  FROM TenpoShohin TS INNER JOIN Shohin S
    ON TS.shohin_id = S.shohin_id
 WHERE TS.tenpo_id = '000A';
 tenpo_id | tenpo_mei | shohin_id |   shohin_mei   | hanbai_tanka 
----------+-----------+-----------+----------------+--------------
 000A     | 東京      | 0001      | Tシャツ        |         1000
 000A     | 東京      | 0002      | 穴あけパンチ   |          500
 000A     | 東京      | 0003      | カッターシャツ |         4000
(3 rows)
```

結合演算は、一度テーブルを結合してしまえば、その後は**WHERE、GROUP BY、HAVING、ORDER BY**を今まで通り使うことができる。
結合したテーブルはSELECT文が実行されている間しか存在しないので、残しておきたければ「ビュー」として作れば良い。

**複数の結合キーを指定する**
```sql
SELECT TS.tenpo_id, TS.tenpo_mei, S.shohin_id, S.shohin_mei, S.hanbai_tanka
  FROM TenpoShohin TS INNER JOIN Shohin S
    ON TS.shohin_id = S.shohin_id
AND S.shohin_mei = 'フォーク';
 tenpo_id | tenpo_mei | shohin_id | shohin_mei | hanbai_tanka 
----------+-----------+-----------+------------+--------------
 000B     | 名古屋    | 0006      | フォーク   |          500
 000C     | 大阪      | 0006      | フォーク   |          500
(2 rows)
```
**WHERE**句と同じことができる。

### 外部結合---OUTER JOIN
外部結合も、2つのテーブルをON句の結合キーでつなぎ、2つのテーブルから同時に列を選択するのは同じ。
結果の形が違う。
```sql
SELECT TS.tenpo_id, TS.tenpo_mei, S.shohin_id, S.shohin_mei, S.hanbai_tanka
  FROM TenpoShohin TS RIGHT OUTER JOIN Shohin S
    ON TS.shohin_id = S.shohin_id
ORDER BY tenpo_id;
 tenpo_id | tenpo_mei | shohin_id |   shohin_mei   | hanbai_tanka 
----------+-----------+-----------+----------------+--------------
 000A     | 東京      | 0002      | 穴あけパンチ   |          500
 000A     | 東京      | 0003      | カッターシャツ |         4000
 000A     | 東京      | 0001      | Tシャツ        |         1000
 000B     | 名古屋    | 0006      | フォーク       |          500
 000B     | 名古屋    | 0002      | 穴あけパンチ   |          500
 000B     | 名古屋    | 0003      | カッターシャツ |         4000
 000B     | 名古屋    | 0004      | 包丁           |         3000
 000B     | 名古屋    | 0007      | おろしがね     |          880
 000C     | 大阪      | 0006      | フォーク       |          500
 000C     | 大阪      | 0007      | おろしがね     |          880
 000C     | 大阪      | 0003      | カッターシャツ |         4000
 000C     | 大阪      | 0004      | 包丁           |         3000
 000D     | 福岡      | 0001      | Tシャツ        |         1000
          |           | 0005      | 圧力鍋         |         6800 ←内部結合のときはなかった
          |           | 0008      | ボールペン     |          100 ←内部結合のときはなかった
(15 rows)
```

外部結合のポイント
**①片方のテーブルの情報がすべて出力される**
内部結合の時に出てこなかった「圧力鍋」と「ボールペン」が選択された。
内部結合は2つのテーブルの両方に存在している情報だけを選択するため、`Shohin`テーブルにしか存在していない「圧力鍋」と「ボールペン」は選択されなかった。
それに対し、外部結合は片方のテーブルに存在していれば選択される。

これを使う例として、行数固定の定型帳票を作りたいとき。
ここで内部結合すると、結果行数が変動してしまう。

テーブルからわからない情報（圧力鍋の店舗IDや店舗名）は**NULL**となる。

**②どちらのテーブルをマスタにするか**
外部結合では、マスタに選択したテーブルの情報がすべて出力される。
マスタを指定するキーワードが「**LEFT**」「**RIGHT**」である。
**LEFT**を使えば、FROM句で左側に書いたテーブルがマスタになり。**RIGHT**を使えば、右側に書いたテーブルがマスタになる。
1つ前のSQLでは、**RIGHT**を使って右側に`Shohin`テーブルを書いているので、`Shohin`テーブルがマスタになっている。
今度は、**LEFT**を使って左側に`Shohin`テーブルを書いてマスタにする。
```sql
SELECT TS.tenpo_id, TS.tenpo_mei, S.shohin_id, S.shohin_mei, S.hanbai_tanka
  FROM Shohin AS S LEFT OUTER JOIN TenpoShohin AS TS
    ON TS.shohin_id = S.shohin_id
ORDER BY tenpo_id;
 tenpo_id | tenpo_mei | shohin_id |   shohin_mei   | hanbai_tanka 
----------+-----------+-----------+----------------+--------------
 000A     | 東京      | 0002      | 穴あけパンチ   |          500
 000A     | 東京      | 0003      | カッターシャツ |         4000
 000A     | 東京      | 0001      | Tシャツ        |         1000
 000B     | 名古屋    | 0006      | フォーク       |          500
 000B     | 名古屋    | 0002      | 穴あけパンチ   |          500
 000B     | 名古屋    | 0003      | カッターシャツ |         4000
 000B     | 名古屋    | 0004      | 包丁           |         3000
 000B     | 名古屋    | 0007      | おろしがね     |          880
 000C     | 大阪      | 0006      | フォーク       |          500
 000C     | 大阪      | 0007      | おろしがね     |          880
 000C     | 大阪      | 0003      | カッターシャツ |         4000
 000C     | 大阪      | 0004      | 包丁           |         3000
 000D     | 福岡      | 0001      | Tシャツ        |         1000
          |           | 0005      | 圧力鍋         |         6800
          |           | 0008      | ボールペン     |          100
(15 rows)
```
結果的にどちらを使っても同じになるが、一般的には、LEFTを使う。
